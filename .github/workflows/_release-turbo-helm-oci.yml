name: Release Turbo Helm Chart (OCI)

on:
  workflow_call:
    inputs:
      version: { required: true, type: string }
      chart_path: { required: true, type: string }     # e.g. deploy-k8s/charts/service
      chart_repo_base: { required: true, type: string }     # e.g. royfw/charts/rfjs
      app_id: { required: true, type: string }            # e.g. api
      environment: { required: true, type: string }
      namespace: { required: true, type: string }
    secrets:
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      GIT_TOKEN: { required: true }

jobs:
  release-helm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: royfw/rf-devops
          token: ${{ secrets.GIT_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 3.14.0

      - name: Login to Harbor
        shell: bash
        run: |
          set -euo pipefail
          RAW='${{ secrets.HARBOR_HOST }}'
          HOST="$(printf '%s' "$RAW" | tr -d '\r' | xargs)"
          HOST="${HOST#http://}"; HOST="${HOST#https://}"; HOST="${HOST%/}"
          echo "HARBOR_HOST_NORMALIZED=$HOST" >> "$GITHUB_ENV"

          echo '${{ secrets.HARBOR_TOKEN }}' | helm registry login "$HOST" \
            --username '${{ secrets.HARBOR_USERNAME }}' \
            --password-stdin

      - name: Package and Push
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          CHART_PATH: ${{ inputs.chart_path }}     # é€šç”¨æ¨¡æ¿ e.g. deploy-k8s/charts/service
          CHART_REPO_BASE: ${{ inputs.chart_repo_base }}     # å€‰åº«è·¯å¾‘ e.g. royfw/charts/rfjs
          APP_ID: ${{ inputs.app_id }}             # æ‡‰ç”¨åç¨± e.g. api
          PROJECT_ENV: ${{ inputs.environment }}   # ç’°å¢ƒ e.g. k8s-royfw
          PROJECT_ROOT: ${{ inputs.namespace }}    # å°ˆæ¡ˆ e.g. rfjs
        run: |
          set -euo pipefail

          RAW_VERSION="${VERSION}"
          
          # çµæœ: 0.0.2-alpha.0-k8s-royfw
          ENV_TAG="${PROJECT_ENV}"
          CHART_VERSION="${RAW_VERSION}-${ENV_TAG}"
          
          # 1. å®šç¾©è·¯å¾‘è®Šæ•¸
          CHART_NAME="$APP_ID"
          ENV_HELM_DIR="./${PROJECT_ROOT}/env/${PROJECT_ENV}/helm"
          APP_SPECIFIC_VALUES="${ENV_HELM_DIR}/${APP_ID}.yaml"
          
          echo "ğŸ› ï¸ æ­£åœ¨ç‚º $CHART_NAME æº–å‚™ç’°å¢ƒå°ˆå±¬ Chart (ç’°å¢ƒ: $PROJECT_ENV)"

          # 2. è™•ç† Chart.yaml (ç’°å¢ƒå…±ç”¨é…ç½®)
          # å¦‚æœç’°å¢ƒç›®éŒ„ä¸‹æœ‰ Chart.yamlï¼Œå…ˆè¦†è“‹é€šç”¨æ¨¡æ¿
          if [[ -f "${ENV_HELM_DIR}/Chart.yaml" ]]; then
            echo "ğŸ“ è¦†è“‹ç’°å¢ƒå…±ç”¨ Chart.yaml: ${ENV_HELM_DIR}/Chart.yaml"
            cp -f "${ENV_HELM_DIR}/Chart.yaml" "$CHART_PATH/Chart.yaml"
          fi
          
          # å¼·åˆ¶ä¿®æ­£ Chart name ç¢ºä¿èˆ‡ APP_ID ä¸€è‡´ï¼Œé€™æœƒå½±éŸ¿ OCI æœ€çµ‚è·¯å¾‘
          sed -i.bak "s/^name: .*/name: $CHART_NAME/" "$CHART_PATH/Chart.yaml"

          # 3. è™•ç† values.yaml (å±¤ç–Šè¦†è“‹)
          # A. å¦‚æœç’°å¢ƒç›®éŒ„ä¸‹æœ‰åŸºç¤ values.yamlï¼Œå…ˆå¥—ç”¨
          if [[ -f "${ENV_HELM_DIR}/values.yaml" ]]; then
            echo "ğŸ“ å¥—ç”¨ç’°å¢ƒåŸºç¤ values: ${ENV_HELM_DIR}/values.yaml"
            cp -f "${ENV_HELM_DIR}/values.yaml" "$CHART_PATH/values.yaml"
          fi
          
          # B. å¦‚æœæœ‰ App å°ˆå±¬çš„ç’°å¢ƒè¨­å®šæª” (api.yaml)ï¼Œæœ€å¾Œè¦†è“‹ä½œç‚º OCI å…§å»ºé è¨­
          if [[ -f "$APP_SPECIFIC_VALUES" ]]; then
            echo "ğŸ“ æ³¨å…¥ App å°ˆå±¬è¨­å®šè‡³ values.yaml: $APP_SPECIFIC_VALUES"
            cp -f "$APP_SPECIFIC_VALUES" "$CHART_PATH/values.yaml"
          fi

          # 4. æ‰“åŒ…èˆ‡æ¨é€
          OUT_DIR="$(pwd)/.helm-packages"
          mkdir -p "$OUT_DIR"

          # åœ¨è™•ç†å®Œ Chart.yaml èˆ‡ values.yaml å¾Œï¼Œæ‰“åŒ…å‰åŸ·è¡Œ
          echo "ğŸ“¦ Updating dependencies..."
          helm dependency update "$CHART_PATH"

          helm package "$CHART_PATH" \
            --version "$CHART_VERSION" \
            --app-version "$RAW_VERSION" \
            --destination "$OUT_DIR"

          PKG="$(ls -1 "$OUT_DIR"/*.tgz | tail -n 1)"
          
          echo "ğŸš€ Pushing OCI artifact: $PKG to oci://${HARBOR_HOST_NORMALIZED}/${CHART_REPO_BASE}"
          helm push "$PKG" "oci://${HARBOR_HOST_NORMALIZED}/${CHART_REPO_BASE}"

      - name: Logout Harbor
        if: always()
        run: |
          helm registry logout "${HARBOR_HOST_NORMALIZED}" || true