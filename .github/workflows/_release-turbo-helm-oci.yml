name: Release Turbo Helm Chart (OCI)

on:
  workflow_call:
    inputs:
      version: { required: true, type: string }
      chart_path: { required: true, type: string }
      chart_repo_base: { required: true, type: string }
      app_id: { required: true, type: string }
      environment: { required: true, type: string }
      namespace: { required: true, type: string }
    secrets:
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      GIT_TOKEN: { required: true }

jobs:
  release-helm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: royfw/rf-devops
          token: ${{ secrets.GIT_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 3.14.0

      - name: Login to Harbor
        shell: bash
        run: |
          set -euo pipefail
          HOST='${{ secrets.HARBOR_HOST }}'
          HOST="${HOST#http://}"; HOST="${HOST#https://}"; HOST="${HOST%/}"
          echo "HARBOR_HOST_NORMALIZED=$HOST" >> "$GITHUB_ENV"
          echo '${{ secrets.HARBOR_TOKEN }}' | helm registry login "$HOST" \
            --username '${{ secrets.HARBOR_USERNAME }}' --password-stdin

      - name: Package and Push
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          CHART_PATH: ${{ inputs.chart_path }}
          CHART_REPO_BASE: ${{ inputs.chart_repo_base }}  # e.g., royfw/rfjs/charts
          APP_ID: ${{ inputs.app_id }}
          PROJECT_ENV: ${{ inputs.environment }}        # e.g., k8s-royfw
          PROJECT_ROOT: ${{ inputs.namespace }}
        run: |
          set -euo pipefail

          # âœ… 1. æ¢å¾©ç´”æ·¨ç‰ˆè™Ÿï¼Œä¸å†æ‹¼æ¥ç’°å¢ƒååˆ° Tag
          CHART_VERSION="${VERSION}"
          CHART_NAME="$APP_ID"
          
          # âœ… 2. æ§‹å»ºå¸¶æœ‰ç’°å¢ƒçš„è·¯å¾‘ (æ–¹æ¡ˆ A: .../charts/ç’°å¢ƒ/App)
          # é€™è£¡æ¨é€åˆ°çˆ¶è·¯å¾‘ï¼Œhelm push æœƒè‡ªå‹•è£œä¸Š APP_ID é€™ä¸€å±¤
          TARGET_REPO_ROOT="${CHART_REPO_BASE}/${PROJECT_ENV}"
          
          ENV_HELM_DIR="./${PROJECT_ROOT}/env/${PROJECT_ENV}/helm"
          APP_SPECIFIC_VALUES="${ENV_HELM_DIR}/${APP_ID}.yaml"

          echo "ğŸ› ï¸ æº–å‚™ç’°å¢ƒå°ˆå±¬ Chart: $CHART_NAME (è·¯å¾‘: $TARGET_REPO_ROOT)"

          # 3. è™•ç†è¦†å¯«é‚è¼¯ (ç¶­æŒåŸæ¨£)
          [ -f "${ENV_HELM_DIR}/Chart.yaml" ] && cp -f "${ENV_HELM_DIR}/Chart.yaml" "$CHART_PATH/Chart.yaml"
          [ -f "${ENV_HELM_DIR}/values.yaml" ] && cp -f "${ENV_HELM_DIR}/values.yaml" "$CHART_PATH/values.yaml"
          [ -f "$APP_SPECIFIC_VALUES" ] && cp -f "$APP_SPECIFIC_VALUES" "$CHART_PATH/values.yaml"

          # 4. åŒæ­¥ Chart å…ƒæ•¸æ“š
          sed -i.bak "s/^name: .*/name: $CHART_NAME/" "$CHART_PATH/Chart.yaml"
          sed -i.bak "s/^version: .*/version: $CHART_VERSION/" "$CHART_PATH/Chart.yaml"

          # 5. æ‰“åŒ…
          helm dependency update "$CHART_PATH"
          OUT_DIR="$(pwd)/.helm-packages"
          mkdir -p "$OUT_DIR"
          helm package "$CHART_PATH" --version "$CHART_VERSION" --app-version "$VERSION" --destination "$OUT_DIR"

          # 6. æ¨é€è‡³ç’°å¢ƒå°ˆå±¬è·¯å¾‘
          PKG="$(ls -1 "$OUT_DIR"/*.tgz | tail -n 1)"
          # æ¨é€åˆ° .../charts/k8s-royfwï¼Œæœ€çµ‚åœ¨ Harbor æœƒæ˜¯ .../charts/k8s-royfw/api
          helm push "$PKG" "oci://${HARBOR_HOST_NORMALIZED}/${TARGET_REPO_ROOT}"