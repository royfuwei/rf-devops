name: Release Turbo Helm Chart (OCI)

on:
  workflow_call:
    inputs:
      version: { required: true, type: string }
      chart_path: { required: true, type: string }
      chart_repo_base: { required: true, type: string }
      image_repo_base: { required: true, type: string }
      app_id: { required: true, type: string }
      environment: { required: true, type: string }
      namespace: { required: true, type: string }
    secrets:
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      GIT_TOKEN: { required: true }

jobs:
  release-helm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: royfw/rf-devops
          token: ${{ secrets.GIT_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 3.14.0

      - name: Login to Harbor
        shell: bash
        run: |
          set -euo pipefail
          HOST='${{ secrets.HARBOR_HOST }}'
          HOST="${HOST#http://}"; HOST="${HOST#https://}"; HOST="${HOST%/}"
          echo "HARBOR_HOST_NORMALIZED=$HOST" >> "$GITHUB_ENV"
          echo '${{ secrets.HARBOR_TOKEN }}' | helm registry login "$HOST" \
            --username '${{ secrets.HARBOR_USERNAME }}' --password-stdin

      - name: Package and Push
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          CHART_PATH: ${{ inputs.chart_path }}
          CHART_REPO_BASE: ${{ inputs.chart_repo_base }}
          IMAGE_REPO_BASE: ${{ inputs.image_repo_base }}
          APP_ID: ${{ inputs.app_id }}
          PROJECT_ENV: ${{ inputs.environment }}
          PROJECT_ROOT: ${{ inputs.namespace }}
          HARBOR_HOST: ${{ secrets.HARBOR_HOST }}
        run: |
          set -euo pipefail

          CHART_VERSION="${VERSION}"
          CHART_NAME="$APP_ID"
          TARGET_REPO_ROOT="${CHART_REPO_BASE}/${PROJECT_ENV}"
          
          ENV_HELM_DIR="./${PROJECT_ROOT}/env/${PROJECT_ENV}/helm"
          APP_SPECIFIC_VALUES="${ENV_HELM_DIR}/${APP_ID}.yaml"

          # 1. 處理覆寫邏輯 (基礎模板 < 環境共用 < App 專屬)
          # 先完成檔案合併，確保最後被 sed 修改的是最終成品
          [ -f "${ENV_HELM_DIR}/Chart.yaml" ] && cp -f "${ENV_HELM_DIR}/Chart.yaml" "$CHART_PATH/Chart.yaml"
          [ -f "${ENV_HELM_DIR}/values.yaml" ] && cp -f "${ENV_HELM_DIR}/values.yaml" "$CHART_PATH/values.yaml"
          [ -f "$APP_SPECIFIC_VALUES" ] && cp -f "$APP_SPECIFIC_VALUES" "$CHART_PATH/values.yaml"

          # 2. ✅ 動態注入「開箱即用」配置 (必須在 cp 之後！)
          IMAGE_PATH="${HARBOR_HOST}/${IMAGE_REPO_BASE}/${PROJECT_ROOT}/${APP_ID}"
          
          # 使用更加寬鬆的 sed 匹配，確保能抓到 repository: "" 或 repository:
          # 並確保 tag 也有引號保護
          sed -i.bak -E "s|repository:.*|repository: \"${IMAGE_PATH}\"|g" "$CHART_PATH/values.yaml"
          sed -i.bak -E "s|tag:.*|tag: \"${VERSION}\"|g" "$CHART_PATH/values.yaml"

          # 注入全名覆蓋
          FULLNAME="${PROJECT_ROOT}-${APP_ID}"
          if grep -q "fullnameOverride:" "$CHART_PATH/values.yaml"; then
            sed -i.bak -E "s|fullnameOverride:.*|fullnameOverride: \"${FULLNAME}\"|g" "$CHART_PATH/values.yaml"
          else
            echo "fullnameOverride: \"${FULLNAME}\"" >> "$CHART_PATH/values.yaml"
          fi

          # 3. 同步 Chart 元數據 (包含 appVersion)
          sed -i.bak "s|^name: .*|name: $CHART_NAME|" "$CHART_PATH/Chart.yaml"
          sed -i.bak "s|^version: .*|version: $CHART_VERSION|" "$CHART_PATH/Chart.yaml"
          sed -i.bak "s|^appVersion: .*|appVersion: \"$VERSION\"|" "$CHART_PATH/Chart.yaml"

          # 4. 打包與推送
          helm dependency update "$CHART_PATH"
          OUT_DIR="$(pwd)/.helm-packages"
          mkdir -p "$OUT_DIR"
          
          helm package "$CHART_PATH" \
            --version "$CHART_VERSION" \
            --app-version "$VERSION" \
            --destination "$OUT_DIR"

          PKG="$(ls -1 "$OUT_DIR"/*.tgz | tail -n 1)"
          helm push "$PKG" "oci://${HARBOR_HOST_NORMALIZED}/${TARGET_REPO_ROOT}"