name: Release Helm Service Chart (OCI)

on:
  workflow_call:
    inputs:
      app_version: { required: true, type: string }
    secrets:
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      GIT_TOKEN: { required: true } # ✅ 必須宣告，才能接收從外部傳入的 Token

jobs:
  release-helm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: royfw/rf-devops
          token: ${{ secrets.GIT_TOKEN }} # ✅ 現在可以正確讀取了
          
      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Login to Harbor
        run: |
          echo "${{ secrets.HARBOR_TOKEN }}" | helm registry login ${{ secrets.HARBOR_HOST }} \
            --username ${{ secrets.HARBOR_USERNAME }} --password-stdin
      
      - name: Package and Push
        run: |
          # 這裡的路徑現在相對於 rf-devops 根目錄是正確的
          CHART_PATH="deploy-k8s/charts/service"
          DYNAMIC_VERSION="${{ inputs.app_version }}"
          
          helm package $CHART_PATH --version "$DYNAMIC_VERSION" --app-version "$DYNAMIC_VERSION"
          helm push rfjs-service-${DYNAMIC_VERSION}.tgz oci://${{ secrets.HARBOR_HOST }}/royfw/charts