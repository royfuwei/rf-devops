name: Reusable Turbo Docker Build

on:
  workflow_call:
    inputs:
      project: # æ–°å¢ž project åƒæ•¸
        type: string
        required: true
      app_id: # å»ºè­°èˆ‡ OCI æµç¨‹çµ±ä¸€ï¼Œç›´æŽ¥å‚³ app_id
        type: string
        required: true
      image_repo_base:
        type: string
        default: royfw
      version:
        type: string
        required: true
      buildPath:
        type: string
        required: true
      environment:
        type: string
        required: true
    secrets:
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      envPAT: { required: true }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.envPAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_HOST }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_TOKEN }}

      - name: Extract Metadata
        id: meta
        run: |
          APP_PATH=$(dirname "${{ inputs.buildPath }}" | sed 's|^\./||')
          SCOPE=$(node -p "require('./$APP_PATH/package.json').name")
          
          # âœ… æ§‹å»ºç¬¦åˆæ–°æž¶æ§‹çš„ Image Tag
          # æ ¼å¼: harbor.com/royfw/rfjs/api:1.0.0
          FULL_IMAGE_NAME="${{ secrets.HARBOR_HOST }}/${{ inputs.image_repo_base }}/${{ inputs.project }}/${{ inputs.app_id }}"
          
          echo "app_path=$APP_PATH" >> "$GITHUB_OUTPUT"
          echo "scope=$SCOPE" >> "$GITHUB_OUTPUT"
          echo "full_image=$FULL_IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "ðŸš€ Image: $FULL_IMAGE_NAME, Scope: $SCOPE"

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ inputs.buildPath }}
          push: true
          tags: |
            ${{ steps.meta.outputs.full_image }}:${{ inputs.version }}
            ${{ steps.meta.outputs.full_image }}:latest
          build-args: |
            TURBO_SCOPE=${{ steps.meta.outputs.scope }}
            TURBO_APP_PATH=${{ steps.meta.outputs.app_path }}
            NODE_VERSION=22.21
          cache-from: type=gha
          cache-to: type=gha,mode=max