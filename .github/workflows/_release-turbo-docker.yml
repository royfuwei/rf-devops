name: Reusable Turbo Docker Build

on:
  workflow_call:
    inputs:
      projectName:
        type: string
        required: true
      projectSource:
        type: string
        default: royfw
      version:
        type: string
        required: true
      buildPath:
        type: string
        required: true # å‚³å…¥: ./apps/api/Dockerfile
      environment:
        type: string
        required: true
    secrets:
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      envPAT: { required: true }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.envPAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_HOST }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_TOKEN }}

      # âœ… è‡ªå‹•è§£æ Dockerfile æ‰€éœ€çš„åƒæ•¸
      - name: Extract Metadata
        id: meta
        run: |
          # 1. è§£æ APP å°ˆæ¡ˆè·¯å¾‘ (ä¾‹å¦‚: apps/api)
          APP_PATH=$(dirname "${{ inputs.buildPath }}" | sed 's|^\./||')
          # 2. å–å¾— package.json è£¡çš„ name ä½œç‚º TURBO_SCOPE (ä¾‹å¦‚: @rfjs/api)
          SCOPE=$(node -p "require('./$APP_PATH/package.json').name")
          
          echo "app_path=$APP_PATH" >> "$GITHUB_OUTPUT"
          echo "scope=$SCOPE" >> "$GITHUB_OUTPUT"
          echo "ğŸš€ Scope: $SCOPE, Path: $APP_PATH"

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          # âš ï¸ é‡è¦ï¼šContext å¿…é ˆæ˜¯æ ¹ç›®éŒ„ï¼ŒTurbo æ‰èƒ½ prune
          context: .
          file: ${{ inputs.buildPath }}
          push: true
          tags: |
            ${{ secrets.HARBOR_HOST }}/${{ inputs.projectSource }}/${{ inputs.projectName }}:${{ inputs.version }}
            ${{ secrets.HARBOR_HOST }}/${{ inputs.projectSource }}/${{ inputs.projectName }}:latest
          build-args: |
            TURBO_SCOPE=${{ steps.meta.outputs.scope }}
            TURBO_APP_PATH=${{ steps.meta.outputs.app_path }}
            NODE_VERSION=22.21
          # ä½¿ç”¨ GitHub Actions ç·©å­˜æ©Ÿåˆ¶
          cache-from: type=gha
          cache-to: type=gha,mode=max