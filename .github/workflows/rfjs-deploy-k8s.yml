name: Deploy rfjs k8s (Granular)

on:
  workflow_call:
    inputs:
      ref:
        type: string
        required: true
      environment:
        type: string
        default: k8s-royfuwei
      namespace:
        type: string
        default: rfjs
    secrets:
      GIT_TOKEN: { required: true }
      KUBE_CONFIG: { required: true }
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }

jobs:
  # --- Job 1: åµæ¸¬è®Šå‹•çš„ Apps (Matrix Generator) ---
  detect:
    runs-on: ubuntu-latest
    outputs:
      apps_matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_apps: ${{ steps.set-matrix.outputs.has_apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}
          ref: ${{ inputs.ref }}

      - name: Compute App Matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail
          # 1. å»ºç«‹å°æ¯”åŸºæº– (å°æ¯” main åˆ†æ”¯)
          BASE=$(node -p "require('./.changeset/config.json').baseBranch || 'main'")
          git fetch origin "+refs/heads/${BASE}:refs/remotes/origin/${BASE}"
          git branch -f "$BASE" "refs/remotes/origin/${BASE}"

          # 2. æ‰¾å‡º apps/ ä¸‹ package.json æœ‰è®Šå‹•çš„ç›®éŒ„
          CHANGED_JSONS=$(git diff --name-only origin/$BASE...HEAD | grep '^apps/.*package.json$' || echo "")
          
          MATRIX_JSON="[]"
          HAS_APPS=false

          for file in $CHANGED_JSONS; do
            DIR=$(dirname $file)
            APP_ID=$(basename $DIR)
            PKG_NAME=$(node -p "require('./$DIR/package.json').name")
            VERSION=$(node -p "require('./$DIR/package.json').version")

            # ç¢ºä¿è©²ç›®éŒ„ä¸‹æœ‰ Dockerfile æ‰åŠ å…¥ Matrix
            if [ -f "$DIR/Dockerfile" ]; then
              echo "ğŸ¯ Detected Change: $APP_ID v$VERSION"
              MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ". += [{\"id\": \"$APP_ID\", \"pkg\": \"$PKG_NAME\", \"version\": \"$VERSION\", \"path\": \"$DIR\"}]")
              HAS_APPS=true
            fi
          done

          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"
          echo "has_apps=$HAS_APPS" >> "$GITHUB_OUTPUT"

  # --- Job 2: ä¸¦è¡Œ Build Docker Images (å¦‚æœ‰ 3 å€‹ App å‹•ï¼Œå‰‡é–‹ 3 å€‹ Job) ---
  docker-build:
    needs: detect
    if: needs.detect.outputs.has_apps == 'true'
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect.outputs.apps_matrix) }}
    uses: ./.github/workflows/_release-turbo-docker.yml
    with:
      projectName: rfjs-${{ matrix.app.id }}
      projectSource: royfuwei
      version: ${{ matrix.app.version }}
      buildPath: ./${{ matrix.app.path }}/Dockerfile
      environment: ${{ inputs.environment }}
    # âŒ ç§»é™¤ secrets: inherit
    # âœ… æ”¹ç‚ºæ˜ç¢ºå‚³éï¼Œç¢ºä¿åç¨±èˆ‡ _release-turbo-docker.yml çš„ inputs å°é½Š
    secrets:
      HARBOR_HOST: ${{ secrets.HARBOR_HOST }}
      HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
      HARBOR_TOKEN: ${{ secrets.HARBOR_TOKEN }}
      envPAT: ${{ secrets.GIT_TOKEN }} # é€™è£¡å°‡ GIT_TOKEN æ˜ å°„çµ¦å­ workflow çš„ envPAT

  # --- Job 3: æœ€çµ‚çµ±ä¸€éƒ¨ç½² (æ‰€æœ‰ Build æˆåŠŸå¾ŒåŸ·è¡Œä¸€æ¬¡) ---
  deploy-k8s:
    needs: [detect, docker-build]
    if: needs.detect.outputs.has_apps == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout DevOps Tools
        uses: actions/checkout@v4
        with:
          repository: royfuwei/rf-devops
          token: ${{ secrets.GIT_TOKEN }}

      - name: Deploy via Helm
        uses: WyriHaximus/github-action-helm3@v3
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
          HARBOR_HOST: ${{ secrets.HARBOR_HOST }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_TOKEN: ${{ secrets.HARBOR_TOKEN }}
          # âœ… é€™è£¡å¿…é ˆæ‰‹å‹•åˆ—å‡ºæ‰€æœ‰åœ¨ .keys æª”æ¡ˆä¸­å®šç¾©éçš„è®Šæ•¸
          # é€™æ˜¯ç‚ºäº†è®“ deploy-secret.sh çš„ ${!key} èƒ½æŠ“åˆ°å€¼
          DATABASE_URL: ${{ secrets.ENV_DATABASE_URL }}
          APP_NAME: ${{ secrets.ENV_API_APP_NAME }}
        with:
          kubeconfig: '${{ secrets.KUBE_CONFIG }}'
          overrule_existing_kubeconfig: "true"
          exec: |
            # ç¢ºä¿åœ¨ rf-devops æ ¹ç›®éŒ„åŸ·è¡Œï¼Œè·¯å¾‘æœƒæœ€æº–ç¢º
            bash ./rfjs/deploy-granular.sh \
              '${{ needs.detect.outputs.apps_matrix }}' \
              '${{ inputs.namespace }}' \
              '${{ inputs.environment }}'