name: Deploy rfjs k8s (Granular)

on:
  workflow_call:
    inputs:
      ref:
        type: string
        required: true
      environment:
        type: string
        default: k8s-royfuwei
      namespace:
        type: string
        default: rfjs
    secrets:
      GIT_TOKEN: { required: true }
      KUBE_CONFIG: { required: true }
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }

jobs:
  # --- Job 1: åµæ¸¬è®Šå‹•çš„ Apps (Matrix Generator) ---
  detect:
    runs-on: ubuntu-latest
    outputs:
      apps_matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_apps: ${{ steps.set-matrix.outputs.has_apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}
          ref: ${{ inputs.ref }}

      - name: Compute App Matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail
          # 1. å»ºç«‹å°æ¯”åŸºæº– (å°æ¯” main åˆ†æ”¯)
          BASE=$(node -p "require('./.changeset/config.json').baseBranch || 'main'")
          git fetch origin "+refs/heads/${BASE}:refs/remotes/origin/${BASE}"
          git branch -f "$BASE" "refs/remotes/origin/${BASE}"

          # 2. æ‰¾å‡º apps/ ä¸‹ package.json æœ‰è®Šå‹•çš„ç›®éŒ„
          CHANGED_JSONS=$(git diff --name-only origin/$BASE...HEAD | grep '^apps/.*package.json$' || echo "")
          
          MATRIX_JSON="[]"
          HAS_APPS=false

          for file in $CHANGED_JSONS; do
            DIR=$(dirname $file)
            APP_ID=$(basename $DIR)
            PKG_NAME=$(node -p "require('./$DIR/package.json').name")
            VERSION=$(node -p "require('./$DIR/package.json').version")

            # ç¢ºä¿è©²ç›®éŒ„ä¸‹æœ‰ Dockerfile æ‰åŠ å…¥ Matrix
            if [ -f "$DIR/Dockerfile" ]; then
              echo "ğŸ¯ Detected Change: $APP_ID v$VERSION"
              MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ". += [{\"id\": \"$APP_ID\", \"pkg\": \"$PKG_NAME\", \"version\": \"$VERSION\", \"path\": \"$DIR\"}]")
              HAS_APPS=true
            fi
          done

          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"
          echo "has_apps=$HAS_APPS" >> "$GITHUB_OUTPUT"

  # --- Job 2: ä¸¦è¡Œ Build Docker Images (å¦‚æœ‰ 3 å€‹ App å‹•ï¼Œå‰‡é–‹ 3 å€‹ Job) ---
  docker-build:
    needs: detect
    if: needs.detect.outputs.has_apps == 'true'
    strategy:
      fail-fast: false # è®“ä¸åŒ App çš„ Build äº’ä¸å½±éŸ¿
      matrix:
        app: ${{ fromJson(needs.detect.outputs.apps_matrix) }}
    # å‘¼å«ä½ å‰›æ‰å‘½åçš„ Reusable Turbo Docker Workflow
    uses: ./.github/workflows/_release-turbo-docker.yml
    with:
      projectName: rfjs-${{ matrix.app.id }}
      projectSource: royfuwei
      version: ${{ matrix.app.version }}
      buildPath: ./${{ matrix.app.path }}/Dockerfile
      environment: ${{ inputs.environment }}
    secrets: inherit

  # --- Job 3: æœ€çµ‚çµ±ä¸€éƒ¨ç½² (æ‰€æœ‰ Build æˆåŠŸå¾ŒåŸ·è¡Œä¸€æ¬¡) ---
  deploy-k8s:
    needs: [detect, docker-build]
    # å³ä½¿æ²’æœ‰ App è®Šå‹•ä¹Ÿæœƒæª¢æŸ¥ï¼Œä½†æˆ‘å€‘é€é if æ“‹ä½
    if: needs.detect.outputs.has_apps == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout DevOps Tools
        uses: actions/checkout@v4
        with:
          repository: royfuwei/rf-devops
          token: ${{ secrets.GIT_TOKEN }}

      - name: Deploy via Helm
        uses: WyriHaximus/github-action-helm3@v3
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
          # å‚³éè®Šå‹•æ¸…å–® JSON çµ¦éƒ¨ç½²è…³æœ¬
          APPS_JSON: ${{ needs.detect.outputs.apps_matrix }}
          NAMESPACE: ${{ inputs.namespace }}
          # é€™è£¡æ”¾å…¥ä½ æ‰€æœ‰çš„ ENV Secrets
          ENV_DB_MONGO_URI: ${{ secrets.ENV_DB_MONGO_URI }}
          ENV_PUBLIC_SUPABASE_URL: ${{ secrets.ENV_PUBLIC_SUPABASE_URL }}
          # ... å…¶é¤˜ Secrets
        with:
          kubeconfig: '${{ secrets.KUBE_CONFIG }}'
          overrule_existing_kubeconfig: "true"
          exec: |
            chmod 600 $HOME/.kube/config
            # 1. å»ºç«‹ K8S Secrets (å¦‚æœéœ€è¦)
            ./rfjs/deploy-secret.sh
            # 2. åŸ·è¡Œã€Œç´°é¡†ç²’åº¦ã€éƒ¨ç½²è…³æœ¬
            # æˆ‘å€‘å°‡ JSON å­—ä¸²å‚³çµ¦è…³æœ¬è™•ç†
            bash ./rfjs/deploy-granular.sh "$APPS_JSON" "$NAMESPACE"