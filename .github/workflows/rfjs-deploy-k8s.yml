name: Deploy rfjs k8s (Granular)

on:
  workflow_call:
    inputs:
      ref: { type: string, required: true }
      environment: { type: string, default: k8s-royfw }
      namespace: { type: string, default: rfjs }
      image_repo_base: { type: string, default: "royfw" } # A 選項：控制 Harbor project (royfw vs rfjs)
      chart_repo_base: { type: string, default: "royfw/rfjs/charts" }
    secrets:
      GIT_TOKEN: { required: true }
      KUBE_CONFIG: { required: true }
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      ENV_DATABASE_URL: { required: false }
      ENV_API_APP_NAME: { required: false }

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      apps_matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_apps: ${{ steps.set-matrix.outputs.has_apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GIT_TOKEN }}
          ref: ${{ inputs.ref }}
      - name: Compute App Matrix
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail
          BASE=$(node -p "require('./.changeset/config.json').baseBranch || 'main'")
          git fetch origin "+refs/heads/${BASE}:refs/remotes/origin/${BASE}"
          git branch -f "$BASE" "refs/remotes/origin/${BASE}"
          CHANGED_JSONS=$(git diff --name-only origin/$BASE...HEAD | grep '^apps/.*package.json$' || echo "")
          MATRIX_JSON="[]"
          HAS_APPS=false
          for file in $CHANGED_JSONS; do
            DIR=$(dirname $file)
            APP_ID=$(basename $DIR)
            PKG_NAME=$(node -p "require('./$DIR/package.json').name")
            VERSION=$(node -p "require('./$DIR/package.json').version")
            if [ -f "$DIR/Dockerfile" ]; then
              MATRIX_JSON=$(echo $MATRIX_JSON | jq -c ". += [{\"id\": \"$APP_ID\", \"pkg\": \"$PKG_NAME\", \"version\": \"$VERSION\", \"path\": \"$DIR\"}]")
              HAS_APPS=true
            fi
          done
          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"
          echo "has_apps=$HAS_APPS" >> "$GITHUB_OUTPUT"

  docker-build:
    needs: detect
    if: needs.detect.outputs.has_apps == 'true'
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect.outputs.apps_matrix) }}
    uses: ./.github/workflows/_release-turbo-docker.yml
    with:
      image_repo: ${{ inputs.namespace }}/${{ matrix.app.id }} # 例如 rfjs/api
      image_repo_base: ${{ inputs.image_repo_base }}           # 例如 royfw
      version: ${{ matrix.app.version }}
      buildPath: ./${{ matrix.app.path }}/Dockerfile
      environment: ${{ inputs.environment }}
    secrets:
      HARBOR_HOST: ${{ secrets.HARBOR_HOST }}
      HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
      HARBOR_TOKEN: ${{ secrets.HARBOR_TOKEN }}
      envPAT: ${{ secrets.GIT_TOKEN }}

  # ✅ 動態發佈通用的 Helm Chart OCI
  helm-release:
    needs: detect
    if: needs.detect.outputs.has_apps == 'true'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect.outputs.apps_matrix) }}
    uses: ./.github/workflows/_release-turbo-helm-oci.yml
    with:
      version: ${{ matrix.app.version }}
      app_id: ${{ matrix.app.id }}
      chart_path: deploy-k8s/charts/service
      # ✅ 關鍵：這裡動態拼接 app.id，達成 oci://.../rfjs/api
      chart_repo_base: ${{ inputs.chart_repo_base }}
      environment: ${{ inputs.environment }}
      namespace: ${{ inputs.namespace }}
    secrets:
      HARBOR_HOST: ${{ secrets.HARBOR_HOST }}
      HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
      HARBOR_TOKEN: ${{ secrets.HARBOR_TOKEN }}
      GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

  deploy-k8s:
    needs: [detect, docker-build, helm-release]
    if: needs.detect.outputs.has_apps == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout DevOps Tools
        uses: actions/checkout@v4
        with:
          repository: royfw/rf-devops
          token: ${{ secrets.GIT_TOKEN }}
      - name: Deploy via Helm
        uses: WyriHaximus/github-action-helm3@v3
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
          HARBOR_HOST: ${{ secrets.HARBOR_HOST }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_TOKEN: ${{ secrets.HARBOR_TOKEN }}
          CHART_REPO_BASE: "${{ inputs.chart_repo_base }}"
          IMAGE_REPO_BASE: "${{ inputs.image_repo_base }}"
          # env
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ENV_DATABASE_URL: ${{ secrets.ENV_DATABASE_URL }}
          ENV_API_APP_NAME: ${{ secrets.ENV_API_APP_NAME }}
          ENV_API_PORT: ${{ secrets.ENV_API_PORT }}
        with:
          kubeconfig: '${{ secrets.KUBE_CONFIG }}'
          exec: |
            bash ./deploy-k8s/deploy-granular.sh \
              '${{ needs.detect.outputs.apps_matrix }}' \
              '${{ inputs.namespace }}' \
              '${{ inputs.environment }}'