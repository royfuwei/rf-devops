name: Release Helm Chart (OCI)

on:
  workflow_call:
    inputs:
      version: { required: true, type: string }
      chart_path: { required: true, type: string }     # e.g. deploy-k8s/charts/service
      chart_repo: { required: true, type: string }     # e.g. royfw/charts/rfjs
      app_id: { required: true, type: string }            # e.g. api
      environment: { required: true, type: string }
    secrets:
      HARBOR_HOST: { required: true }
      HARBOR_USERNAME: { required: true }
      HARBOR_TOKEN: { required: true }
      GIT_TOKEN: { required: true }

jobs:
  release-helm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: royfw/rf-devops
          token: ${{ secrets.GIT_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 3.14.0

      - name: Login to Harbor
        shell: bash
        run: |
          set -euo pipefail
          RAW='${{ secrets.HARBOR_HOST }}'
          HOST="$(printf '%s' "$RAW" | tr -d '\r' | xargs)"
          HOST="${HOST#http://}"; HOST="${HOST#https://}"; HOST="${HOST%/}"
          echo "HARBOR_HOST_NORMALIZED=$HOST" >> "$GITHUB_ENV"

          echo '${{ secrets.HARBOR_TOKEN }}' | helm registry login "$HOST" \
            --username '${{ secrets.HARBOR_USERNAME }}' \
            --password-stdin

      - name: Package and Push
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
          CHART_PATH: ${{ inputs.chart_path }}
          CHART_REPO: ${{ inputs.chart_repo }}
          APP_ID: ${{ inputs.app_id }}
        run: |
          set -euo pipefail
          
          # âœ… å–å¾— APP_ID (å¾ chart_repo çš„æœ€å¾Œä¸€æ®µå–å¾—ï¼Œä¾‹å¦‚ api)
          CHART_NAME=$(basename "$APP_ID")
          echo "ğŸ·ï¸ Dynamic Chart Name: $CHART_NAME"
          
          # âœ… ä¿®æ”¹ Chart.yaml çš„ name å±¬æ€§ï¼Œè®“ K8s è¾¨è­˜åº¦æ›´é«˜
          # é€™è£¡ä½¿ç”¨å‚™ä»½å‰¯æª”å .bak ä»¥ç¢ºä¿ sed åœ¨ä¸åŒç’°å¢ƒçš„ç›¸å®¹æ€§
          sed -i.bak "s/^name: .*/name: $CHART_NAME/" "$CHART_PATH/Chart.yaml"

          OUT_DIR="$(pwd)/.helm-packages"
          mkdir -p "$OUT_DIR"

          # æ‰“åŒ…æ™‚æœƒä½¿ç”¨ä¿®æ”¹éçš„ Chart.yaml
          helm package "$CHART_PATH" \
            --version "$VERSION" \
            --app-version "$VERSION" \
            --destination "$OUT_DIR"

          PKG="$(ls -1 "$OUT_DIR"/*.tgz | tail -n 1)"
          echo "ğŸš€ Pushing OCI artifact: $PKG to oci://${HARBOR_HOST_NORMALIZED}/${CHART_REPO}/${APP_ID}"
          
          helm push "$PKG" "oci://${HARBOR_HOST_NORMALIZED}/${CHART_REPO}"

      - name: Logout Harbor
        if: always()
        run: |
          helm registry logout "${HARBOR_HOST_NORMALIZED}" || true