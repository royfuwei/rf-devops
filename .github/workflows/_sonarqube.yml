name: SonarQube Scan

on:
  workflow_call:
    inputs:
      environment:
        type: string
      projectKey:
        required: true
        type: string
      projectName:
        required: true
        type: string
      projectSource:
        type: string
        default: '.'
    secrets:
      SONAR_HOST_URL:
        required: true
      SONAR_TOKEN:
        required: true

jobs:
  sonarqube-scan:
    # https://docs.sonarsource.com/sonarqube/10.5/devops-platform-integration/github-integration/introduction/
    # https://docs.sonarsource.com/sonarqube/latest/devops-platform-integration/github-integration/monorepo/
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
        with:
          # Disabling shallow clones is recommended for improving the relevancy of reporting
          fetch-depth: 0
      - name: Scan ${{ inputs.projectName }}
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args:
              # Unique key of your project. You can find it in SonarQube > [my project] > Project Information (top-right menu)
              # mandatory
              -Dsonar.projectKey=${{ inputs.projectKey }}
              -Dsonar.projectName=${{ inputs.projectName }}
              -Dsonar.sources=${{ inputs.projectSource }}
              # Comma-separated paths to directories containing main source files.
              #-Dsonar.sources= # optional, default is project base directory
              # When you need the analysis to take place in a directory other than the one from which it was launched
              #-Dsonar.projectBaseDir= # optional, default is .
              # Comma-separated paths to directories containing test source files.
              #-Dsonar.tests= # optional. For more info about Code Coverage, please refer to https://docs.sonarcloud.io/enriching/test-coverage/overview/
              # Adds more detail to both client and server-side analysis logs, activating DEBUG mode for the scanner, and adding client-side environment variables and system properties to the server-side log of analysis report processing.
              #-Dsonar.verbose= # optional, default is false

  scan-quality-gate:
    runs-on: ubuntu-latest
    needs: sonarqube-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Check Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Wait for the background task to finish
          sleep 20
          # Fetch analysis ID
          ANALYSIS_ID=$(curl -s -u $SONAR_TOKEN: "${{ secrets.SONAR_HOST_URL }}/api/ce/task?id=$(curl -s -u $SONAR_TOKEN: '${{ secrets.SONAR_HOST_URL }}/api/ce/component?component='${{ inputs.projectKey }}'&maxResults=1' | jq -r '.currentComponent.analyses[0].id')" | jq -r '.task.analysisId')
          # Fetch Quality Gate status
          STATUS=$(curl -s -u $SONAR_TOKEN: "${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?analysisId=$ANALYSIS_ID" | jq -r '.projectStatus.status')
          # Fail the pipeline if Quality Gate fails
          if [ "$STATUS" != "OK" ]; then
            echo "Quality Gate failed: $STATUS"
            exit 1
          else
            echo "Quality Gate passed: $STATUS"
          fi